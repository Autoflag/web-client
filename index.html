<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoFlag BLE Console</title>
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { margin: 24px; max-width: 900px; }
    button { padding: 10px 14px; font-size: 14px; cursor: pointer; }
    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 0 0 16px; }
    legend { padding: 0 6px; font-weight: 600; }
    label { display: block; margin: 10px 0 4px; font-size: 13px; color: #333; }
    input, select, textarea { width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box; }
    #controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0 16px; }
    #status { white-space: pre-wrap; background: #111; color: #eee; padding: 12px; border-radius: 8px; min-height: 160px; overflow-wrap: anywhere; }
    .grid { display: grid; gap: 10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { opacity: .75; font-size: 12px; }
    .hidden { display: none !important; }
    @media (max-width: 680px) { .grid { grid-template-columns: 1fr; } }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: #fff; border-radius: 12px; width: min(560px, 92vw); box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .modal header { padding: 16px 20px; border-bottom: 1px solid #eee; font-weight: 700; }
    .modal .content { padding: 16px 20px; }
    .steps { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
    .step { display: grid; grid-template-columns: 22px 1fr; align-items: center; gap: 10px; padding: 2px 10px; border: 1px solid #eee; border-radius: 8px; min-height: 44px; }
    /* Icon baseline size + border-box to normalize total size across states */
    .step .icon { width: 20px; height: 20px; display: inline-block; border-radius: 50%; position: relative; box-sizing: border-box; }
    /* Ensure all states reserve the same 2px border to avoid height/width shifts */
    .step.pending .icon,
    .step.active .icon,
    .step.done .icon,
    .step.error .icon { border: 2px solid transparent; }
    .step.pending .icon { border-color: #bbb; background: transparent; }
    .step.active .icon { border-color: #007bff; border-top-color: transparent; background: transparent; animation: spin 0.9s linear infinite; }
    .step.done .icon { background: #16a34a; border-color: #16a34a; }
    .step.done .icon::after { content: "‚úì"; position: absolute; inset: 0; color: #fff; font-size: 14px; display: grid; place-items: center; }
    .step.error { border-color: #dc2626; background: #fff6f6; }
    .step.error .icon { background: #dc2626; border-color: #dc2626; }
    .step.error .icon::after { content: "√ó"; position: absolute; inset: 0; color: #fff; font-size: 14px; display: grid; place-items: center; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal footer { display: flex; gap: 10px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid #eee; }
    .btn { padding: 10px 14px; font-size: 14px; cursor: pointer; border-radius: 8px; border: 1px solid #ddd; background: #f6f6f6; }
    .btn.primary { background: #0ea5e9; color: #fff; border-color: #0ea5e9; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .alert-error { margin-top: 14px; padding: 12px 14px; border: 1px solid #dc2626; background: #fff6f6; color: #991b1b; border-radius: 8px; font-size: 14px; line-height: 1.35; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>AutoFlag Setup</h1>
  <div>
    <span id="userFirstName">-</span>
    <button id="btnLogin" class="hidden" style="margin-left: 20px;">üîê Log In</button>
  </div>
  <br />
  <fieldset>
    <legend>Configuration</legend>
    <div class="grid">
      <div>
        <label for="deviceName">Device Name</label>
        <input id="deviceName" type="text" autocomplete="off" />
      </div>
      <div>
        <label for="ssid">WiFi SSID</label>
        <input id="ssid" type="text" value="CBB" autocomplete="off" />
      </div>
      <div>
        <label for="pss">WiFi Password</label>
        <input id="pss" type="text" value="bbbbbbbbbb" autocomplete="off" />
      </div>
      <div>
        <label for="cou">Country</label>
        <select id="cou">
          <option value="1" selected>United States</option>
          <option value="124">Canada</option>
          <option value="826">United Kingdom</option>
          <option value="36">Australia</option>
          <option value="276">Germany</option>
        </select>
      </div>
      <div>
        <label for="sta">State</label>
        <select id="sta">
          <option value="1" selected>Idaho</option>
          <option value="2">Washington</option>
          <option value="3">Oregon</option>
          <option value="4">California</option>
          <option value="5">Utah</option>
        </select>
      </div>
      <div>
        <label for="cit">City</label>
        <input id="cit" type="text" value="Boise" autocomplete="off" />
      </div>
      <div style="display:none;">
        <label for="id">Device ID</label>
        <input id="id" type="text" class="mono" inputmode="numeric" pattern="[0-9]{6}" autocomplete="off" />
      </div>
    </div>
  </fieldset>

  <div id="controls">
    <button id="btnSendOnce">‚úÖ Configure Device</button>
  </div>

  <label for="jsonPreview">Preview</label>
  <textarea id="jsonPreview" class="mono" rows="6" spellcheck="false" readonly></textarea>

  <h3>Log</h3>
  <pre id="status"></pre>

  <div id="progressModalWrap" class="hidden">
    <div class="modal-overlay">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <header id="modalTitle">Configuring</header>
        <div class="content">
          <ul class="steps">
            <li id="step-1" class="step pending">
              <span class="icon" aria-hidden="true"></span>
              <span>Connect to device</span>
            </li>
            <li id="step-2" class="step pending">
              <span class="icon" aria-hidden="true"></span>
              <span>Send configuration</span>
            </li>
            <li id="step-3" class="step pending">
              <span class="icon" aria-hidden="true"></span>
              <span>Device applies configuration</span>
            </li>
            <li id="step-4" class="step pending">
              <span class="icon" aria-hidden="true"></span>
              <span>Register device to your account</span>
            </li>
            <li id="step-5" class="step pending">
              <span class="icon" aria-hidden="true"></span>
              <span>Device connects to MQTT broker</span>
            </li>
          </ul>
          <div id="modalError" class="alert-error hidden" role="alert"></div>
        </div>
        <footer>
          <button id="btnModalAnother" class="btn">Configure another device</button>
          <button id="btnModalGo" class="btn primary" disabled>Go to device page</button>
        </footer>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
